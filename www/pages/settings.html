<template>
  <div class="page page-settings">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a class="link back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">Paramètres du compte</div>
      </div>
    </div>
    <div class="toolbar tabbar tabbar-icons toolbar-bottom bg-color-white">
      <div class="toolbar-inner">
        <a href="/home/" class="tab-link">
          <i class="icon f7-icons if-not-md font-size-35">house</i>
          <i class="icon material-icons md-only font-size-35">home</i>
          <span class="tabbar-label font-size-17">Accueil</span>
        </a>
        <a href="/subscription/" class="tab-link">
          <i class="icon f7-icons if-not-md font-size-35">creditcard</i>
          <i class="icon material-icons md-only font-size-35">payment</i>
          <span class="tabbar-label font-size-17">Abonnement</span>
        </a>
        <a href="/alert/" class="tab-link">
          <i class="icon f7-icons if-not-md font-size-35"
            >exclamationmark_triangle</i
          >
          <i class="icon material-icons md-only font-size-35">warning_amber</i>
          <span class="tabbar-label font-size-17">Alerte</span>
        </a>
        <a href="/settings/" class="tab-link tab-link-active">
          <i class="icon f7-icons if-not-md font-size-35 text-color-white"
            >gear_alt</i
          >
          <i class="icon material-icons md-only font-size-35 text-color-white"
            >settings</i
          >
          <span class="tabbar-label font-size-17">Paramètres</span>
        </a>
      </div>
    </div>
    <div class="page-content">
      <div class="block block-strong-ios block-outline-ios">
        <div class="block text-align-center">
          <span class="img-profile">
            <img src="img/img5.png" class="img-round-100" id="profilePhoto" />
          </span>
          <span class="img-icon">
            <a class="popup-open" data-popup=".demo-sheet-push">
              <i class="icon f7-icons if-not-md">camera_fill</i>
              <i class="icon material-icons md-only color-yellow"
                >photo_camera</i
              >
            </a>
          </span>

          <h3 class="username"></h3>
          <h4>Statut de l'abonnement : <span class="status"></span></h4>
        </div>
        <div
          class="list inset list-dividers-ios components-list searchbar-found"
        >
          <ul>
            <li class="margin-bottom-20">
              <a class="item-content item-link" href="/profile/">
                <div class="item-media">
                  <i class="icon f7-icons if-not-md color-yellow">person</i>
                  <i class="icon material-icons md-only color-yellow"
                    >person_outline</i
                  >
                </div>
                <div class="item-inner">
                  <div class="item-title">Mon profil</div>
                </div>
              </a>
            </li>
            <li class="margin-bottom-20">
              <a class="item-content item-link" href="/my-contact/">
                <div class="item-media">
                  <i class="icon f7-icons if-not-md color-yellow"
                    >person_crop_rectangle</i
                  >
                  <i class="icon material-icons md-only color-yellow"
                    >contact_mail</i
                  >
                </div>
                <div class="item-inner">
                  <div class="item-title">Contacts d'urgence</div>
                </div>
              </a>
            </li>
            <li class="margin-bottom-20 driver-bloc" style="display: none">
              <a class="item-content item-link" href="/my-subdriver/">
                <div class="item-media">
                  <i class="icon f7-icons if-not-md color-yellow"
                    >person_crop_rectangle</i
                  >
                  <i class="icon material-icons md-only color-yellow"
                    >contact_mail</i
                  >
                </div>
                <div class="item-inner">
                  <div class="item-title">Mon mercenaire</div>
                </div>
              </a>
            </li>
            <li class="margin-bottom-20">
              <a class="item-content item-link" href="/subscription/">
                <div class="item-media">
                  <i class="icon f7-icons if-not-md color-yellow">cart_fill</i>
                  <i class="icon material-icons md-only color-yellow"
                    >shopping_cart</i
                  >
                </div>
                <div class="item-inner">
                  <div class="item-title">Abonnement</div>
                </div>
              </a>
            </li>
            <li class="margin-bottom-20">
              <a class="item-content item-link external" href="tel:117">
                <div class="item-media">
                  <i class="icon f7-icons if-not-md color-yellow"
                    >phone_fill_arrow_up_right</i
                  >
                  <i class="icon material-icons md-only color-yellow"
                    >phone_forwarded</i
                  >
                </div>
                <div class="item-inner">
                  <div class="item-title">Appel 117 : Ambulance et Police</div>
                </div>
              </a>
            </li>
          </ul>
        </div>
        <div class="block text-align-center">
          <a @click="${logout}" class="color-black">
            <i class="icon f7-icons if-not-md font-size-35"
              >square_arrow_right</i
            >
            <i class="icon material-icons md-only font-size-35">exit_to_app</i>
            <h4>Déconnexion</h4>
          </a>
        </div>
      </div>
    </div>
    <div class="popup demo-sheet-push">
      <div class="page">
        <div class="swipe-handler"></div>
        <div class="page-content">
          <div
            class="block-title block-title-large text-align-center text-color-yellow"
          >
            Mettez à jour votre photo de profil
          </div>
          <div class="block block-strong-ios block-outline-ios">
            <img
              src="img/img5.png"
              id="imagePreview5"
              width="100"
              style="display: block; margin: auto"
            />
            <div class="grid grid-cols-2 grid-gap margin-top">
              <div class="bloc-img text-align-center">
                <a
                  id="capturePhoto"
                  @click="${capturePhoto}"
                  class="color-black"
                >
                  <span class="display-block">
                    <img src="img/camera2.png" width="100" />
                  </span>

                  <span class="display-block">Prendre une photo</span>
                </a>
              </div>
              <div class="bloc-img text-align-center">
                <a
                  id="chooseFromGallery"
                  @click="${chooseFromGallery}"
                  class="color-black"
                >
                  <span class="display-block">
                    <img src="img/gallery.jpg" width="55" />
                  </span>

                  <span class="display-block">Choisir depuis la galerie</span>
                </a>
              </div>
            </div>

            <div id="imagePreview"></div>
            <div class="list inset">
              <ul>
                <li>
                  <a
                    @click="${uploadPhoto}"
                    id="uploadPhoto"
                    class="button button-fill color-black list-button button-round"
                  >
                    Valider
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="fab fab-extended fab-center-bottom">
      <a @click="${scanCode}" class="btn-scan">
        <img src="img/icon-qrcode.png" class="img-scan" />
      </a>
    </div>
  </div>
</template>
<style>
  .margin-bottom-20 {
    margin-bottom: 20px;
  }
  .bloc-img {
    border-radius: 14px;
    background: #fff;
    box-shadow: 7px 7px 22px #c6c6c6, -7px -7px 22px #ffffff;
  }
</style>
<script>
  export default (
    props,
    { $, $f7, $on, $f7router, $onMounted, $onBeforeUnmount }
  ) => {
    let popupSwipeHandler;
    let lat = localStorage.getItem("userlat");
    let lng = localStorage.getItem("userlng");
    let userType = localStorage.getItem("type");
    let userId = localStorage.getItem("userId");
    let iscontact = localStorage.getItem("is_emergency_contact_exist");
    $on("pageInit", () => {
      let firstname = localStorage.getItem("firstname");
      let lastname = localStorage.getItem("lastname");
      let status = localStorage.getItem("susbscription_status");
      let profilePhoto = localStorage.getItem("profilePhoto");

      if (status == 0) {
        $(".status").html("<span class='text-color-yellow'>non actif</span>");
      } else {
        $(".status").html("<span class='text-color-green'>actif</span>");
      }

      $(".username").html(firstname + " " + lastname);

      if (userType == "dri") {
        $(".driver-bloc").show();
        $(".passenger-bloc").hide();
      } else {
        $(".driver-bloc").hide();
        $(".passenger-bloc").show();
      }

      if (
        profilePhoto == null ||
        profilePhoto == undefined ||
        profilePhoto == "undefined" ||
        profilePhoto == "" ||
        profilePhoto == "null"
      ) {
        $("#profilePhoto").attr("src", "img/img5.png");
      } else {
        $("#profilePhoto").attr("src", apiUrl + "/api/images/" + profilePhoto);
      }

      popupSwipeHandler = $f7.sheet.create({
        el: ".demo-sheet-push",
        swipeToClose: true,
        push: true,
        backdrop: true,
      });
    });
    // const openMap = () => {
    //   window.open(
    //     "https://www.google.com/maps/search/?api=1&query=" +
    //       lat +
    //       "," +
    //       lng +
    //       "",
    //     "_system"
    //   );
    // };

    const scanCode = () => {
      if (iscontact == 1) {
        cordova.plugins.barcodeScanner.scan(
          function (result) {
            console.log(
              "We got a barcode\n" +
                "Result: " +
                result.text +
                "\n" +
                "Format: " +
                result.format +
                "\n" +
                "Cancelled: " +
                result.cancelled
            );
            if (result.cancelled === true) {
              toastTop = $f7.toast.create({
                text: "Vous avez annulé le scan !",
                position: "top",
                cssClass: "toast_warning",
                closeTimeout: 3000,
              });
              toastTop.open();
            } else {
              let str = result.text.split("-");
              const driver = str[1];
              localStorage.setItem("driver", driver);
              app.views.main.router.navigate("/driver-profile/");
            }
          },
          function (error) {
            toastTop = $f7.toast.create({
              text: "Scanning failed: " + error,
              position: "top",
              cssClass: "toast_red",
              closeTimeout: 3000,
            });
            toastTop.open();
            //alert("Scanning failed: " + error);
          },
          {
            preferFrontCamera: false, // iOS and Android
            showFlipCameraButton: true, // iOS and Android
            showTorchButton: true, // iOS and Android
            torchOn: false, // Android, launch with the torch switched on (if available)
            saveHistory: true, // Android, save scan history (default false)
            prompt: "Place a barcode inside the scan area", // Android
            resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
            formats: "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
            orientation: "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
            disableAnimations: true, // iOS
            disableSuccessBeep: false, // iOS and Android
          }
        );
      } else {
        toastTop = $f7.toast.create({
          text: "Vous n'avez aucun contact d'urgence enregistré ! Prière d'enregistrer au moins 1 contact avant de scanner.",
          position: "top",
          cssClass: "toast_info",
          closeTimeout: 3000,
        });
        toastTop.open();
        app.views.main.router.navigate("/add-contact/");
      }
    };

    // Événement de capture de photo
    const capturePhoto = () => {
      navigator.camera.getPicture(onSuccess, onFail, {
        quality: 50,
        destinationType: Camera.DestinationType.DATA_URL,
      });

      function onSuccess(imageURI) {
        var image = document.getElementById("imagePreview5");
        image.src = "data:image/jpeg;base64," + imageURI;
      }

      function onFail(message) {
        app.dialog.alert("Échec de la capture de photo : " + message);
      }
    };

    // Événement de sélection de photo depuis la galerie
    const chooseFromGallery = () => {
      navigator.camera.getPicture(onSuccess, onFail, {
        quality: 50,
        destinationType: Camera.DestinationType.DATA_URL,
        sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
      });

      function onSuccess(imageURI) {
        var image = document.getElementById("imagePreview5");
        image.src = "data:image/jpeg;base64," + imageURI;
      }

      function onFail(message) {
        app.dialog.alert("Échec de la sélection de photo : " + message);
      }
    };

    // Événement de téléchargement de photo
    const uploadPhoto = () => {
      var imageURI = $("#imagePreview5").attr("src");
      let userId = localStorage.getItem("userId");
      //alert(imageURI);

      if (!imageURI) {
        app.dialog.alert("Veuillez d'abord choisir une photo");
        return;
      }

      // Afficher l'indicateur de chargement
      var loader = app.dialog.progress("Téléchargement en cours...", 0);

      // Convertir l'URI de l'image en données binaires
      fetch(imageURI)
        .then((response) => response.blob())
        .then((blob) => {
          var formData = new FormData();
          formData.append("image", blob, "image.jpg");
          formData.append("userId", userId);

          fetch(apiUrl + "/api/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              // Cacher l'indicateur de chargement une fois la réponse reçue
              loader.close();

              if (!response.ok) {
                throw new Error("Erreur HTTP, statut " + response.status);
              }
              return response.json();
            })
            .then((data) => {
              console.log("response", data);
              toastTop = $f7.toast.create({
                text: "Photo téléversée avec succès !",
                position: "top",
                cssClass: "toast_green",
                closeTimeout: 3000,
              });

              // Open it
              toastTop.open();
              let path = data.path;

              let str = path.split("public/");
              localStorage.setItem("profilePhoto", str[1]);

              $f7.popup.close();
              app.views.main.router.navigate("/settings/");
            })
            .catch((error) => {
              // Cacher l'indicateur de chargement en cas d'erreur
              loader.close();

              app.dialog.alert(
                "Erreur lors du téléversement de la photo : " + error.message
              );
            });
        })
        .catch((error) => {
          // Cacher l'indicateur de chargement en cas d'erreur
          loader.close();

          app.dialog.alert(
            "Erreur lors de la récupération des données de l'image : " +
              error.message
          );
        });

      // Gérer l'événement de progression
      const progressHandler = (event) => {
        // Calculer le pourcentage de progression
        var percentComplete = Math.round((event.loaded / event.total) * 100);

        // Mettre à jour l'indicateur de chargement avec le pourcentage
        loader.update(progressHandler, percentComplete);
      };
    };

    const logout = () => {
      const token = localStorage.getItem("token");

      // API endpoint for creating a new user

      // Make a POST request using the Fetch API
      fetch(apiUrl + "/api/logout", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
          "Access-Control-Allow-Origin": "*",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          userId: userId,
        }),
      })
        .then((response) => {
          if (response.status === 401) {
            return response.json().then((data) => {
              throw new Error(data.message); // Lance une erreur avec le message de la réponse
            });
          } else {
            if (!response.ok) {
              $f7.dialog.close();

              throw new Error("Erreur HTTP, statut " + response.status);
            }
          }
          return response.json();
        })
        .then((newUserData) => {
          localStorage.clear();
          app.dialog.alert("Déconnexion effectuée avec succès !");

          app.views.main.router.navigate("/login/");
        })
        .catch((error) => {
          console.error("Error:", error);
          localStorage.clear();
          toastTop = $f7.toast.create({
            text: "Votre session a expirée ! Vous serez déconnecté",
            position: "top",
            cssClass: "toast_red",
            closeTimeout: 3000,
          });

          // Open it
          toastTop.open();
          app.views.main.router.navigate("/login/");
        });
    };

    $onBeforeUnmount(() => {
      // Destroy popup when page removed
      if (popupSwipeHandler) popupSwipeHandler.destroy();
    });

    return $render;
  };
</script>
