<template>
  <div class="page no-toolbar page-rating">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="/home/" class="link">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title" tkey="RATE_DRIVER">Noter le chauffeur</div>
      </div>
    </div>
    <div class="page-content">
      <div class="block block-strong-ios block-outline-ios">
        <h2 class="title text-align-center" tkey="LEAVE_A_RATE">
          Laissez une note pour ce chauffeur
        </h2>

        <div class="content-block">
          <form id="rating-form">
            <div
              class="list media-list list-strong-ios list-outline-ios list-dividers-ios display-flex"
            >
              <ul id="rating-score">
                <li>
                  <div
                    class="item-radio item-radio-icon-start item-content rating"
                  >
                    <fieldset>
                      <span class="star-cb-group">
                        <input
                          type="radio"
                          id="rating-5"
                          name="rating"
                          value="5"
                        />
                        <label
                          class="icon f7-icons if-not-md star"
                          for="rating-5"
                          >star_fill</label
                        >
                        <label
                          class="icon material-icons md-only star"
                          for="rating-5"
                          >star</label
                        >

                        <input
                          type="radio"
                          id="rating-4"
                          name="rating"
                          value="4"
                        /><label
                          class="icon f7-icons if-not-md star"
                          for="rating-4"
                          >star_fill</label
                        >
                        <label
                          class="icon material-icons md-only star"
                          for="rating-4"
                          >star</label
                        >
                        <input
                          type="radio"
                          id="rating-3"
                          name="rating"
                          value="3"
                        /><label
                          class="icon f7-icons if-not-md star"
                          for="rating-3"
                          >star_fill</label
                        >
                        <label
                          class="icon material-icons md-only star"
                          for="rating-3"
                          >star</label
                        >
                        <input
                          type="radio"
                          id="rating-2"
                          name="rating"
                          value="2"
                        /><label
                          class="icon f7-icons if-not-md star"
                          for="rating-2"
                          >star_fill</label
                        >
                        <label
                          class="icon material-icons md-only star"
                          for="rating-2"
                          >star</label
                        >
                        <input
                          type="radio"
                          id="rating-1"
                          name="rating"
                          value="1"
                        /><label
                          class="icon f7-icons if-not-md star"
                          for="rating-1"
                          >star_fill</label
                        >
                        <label
                          class="icon material-icons md-only star"
                          for="rating-1"
                          >star</label
                        >
                        <input
                          type="radio"
                          id="rating-0"
                          name="rating"
                          value="0"
                          class="star-cb-clear"
                        /><label
                          class="icon f7-icons if-not-md star"
                          for="rating-0"
                          >star_fill</label
                        >
                        <label
                          class="icon material-icons md-only star"
                          for="rating-0"
                          >star</label
                        >
                      </span>
                    </fieldset>
                  </div>
                  <input type="hidden" id="star" name="rating" value="0" />
                </li>
              </ul>
            </div>
            <div class="grid grid-cols-2 grid-gap margin-30">
              <a
                class="button button-big button-block button-fill button-round color-black"
                @click="${ratingDriver}"
                tkey="RATE"
                >Noter</a
              >
              <a
                class="button button-big button-block button-fill button-round button-raised color-yellow"
                tkey="LATER"
                href="/home/"
                >Plus tard</a
              >
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</template>

<style>
  .img-responsive {
    margin: 0 auto;
    display: block;
    max-width: 200px;
  }
  ul li {
    list-style: none;
  }
  .page-rating .list li {
    display: inline-flex;
  }
  .star-cb-group {
    /* remove inline-block whitespace */
    font-size: 0;
    /* flip the order so we can use the + and ~ combinators */
    unicode-bidi: bidi-override;
    direction: rtl;
    /* the hidden clearer */
  }
  .star-cb-group * {
    font-size: 3rem;
  }
  .star-cb-group > input {
    display: none;
  }
  .star-cb-group > input + label {
    /* only enough room for the star */
    display: inline-block;
    overflow: hidden;
    text-indent: 9999px;
    width: 1em;
    white-space: nowrap;
    cursor: pointer;
  }
  .star-cb-group > input + label:before {
    display: inline-block;
    text-indent: -9999px;
    content: "\2606";
    color: #888;
  }
  .star-cb-group > input:checked ~ label:before,
  .star-cb-group > input + label:hover ~ label:before,
  .star-cb-group > input + label:hover:before {
    content: "\2605";
    color: rgb(230, 190, 14);
    text-shadow: 0 0 1px #333;
  }
  .star-cb-group > .star-cb-clear + label {
    text-indent: -9999px;
    width: 0.5em;
    margin-left: -0.5em;
  }
  .star-cb-group > .star-cb-clear + label:before {
    width: 0.5em;
  }
  .star-cb-group:hover > input + label:before {
    content: "\2606";
    color: #888;
    text-shadow: none;
  }
  .star-cb-group:hover > input + label:hover ~ label:before,
  .star-cb-group:hover > input + label:hover:before {
    content: "\2605";
    color: rgb(230, 190, 14);
    text-shadow: 0 0 1px #333;
  }

  fieldset {
    border: 0;
    border-radius: 1px;
    padding: 1em 2.6em 0.9em;
    margin: 1em auto;
  }
  #log {
    margin: 1em auto;
    text-align: center;
    background: transparent;
    font-size: 3em;
  }
</style>

<script>
  export default (props, { $, $f7, $f7router, $on }) => {
    $on("pageInit", () => {
      var logID = "log",
        log = $('<div id="' + logID + '"></div>');
      $("#rating-score").append(log);
      $('[type*="radio"]').change(function () {
        var me = $(this);
        log.html(me.attr("value"));
        $("#star").val(me.attr("value"));
      });
    });

    const ratingDriver = () => {
      $f7.dialog.preloader(ONE_MOMENT);
      let score = $("#star").val();
      let userId = localStorage.getItem("userId");
      let driver = props.driver;
      if (score == "") {
        $f7.dialog.alert(PLEASE_WRITE_RATING);
      } else {
        // API endpoint for creating a new user
        const apiUrl3 = apiUrl + "/api/rating/add";

        // Form data to be sent in the request body
        const formData = {
          score: score,
          passenger: userId,
          driver: driver,
        };

        fetch(apiUrl3, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => {
            if (!response.ok) {
              $f7.dialog.close();
              throw new Error("Network response was not ok");
              app.dialog.alert(ERROR_NOTIFICATION);
            }
            return response.json();
          })
          .then((data) => {
            // Process the newly created user data

            $f7.dialog.close();

            $f7.dialog.alert(THANK_TO_LEAVE_A_RATING, function () {
              $f7.popup.close();
              var mainView = app.view.main;
              mainView.router.navigate("/home/");
            });
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    };

    return $render;
  };
</script>
