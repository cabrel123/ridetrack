<template>
  <div class="page page-verify-phone">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a class="link back">
            <i class="icon icon-back"></i>
            <span class="if-not-md">Back</span>
          </a>
        </div>
        <div class="title">Vérification du compte</div>
      </div>
    </div>
    <div class="page-content">
      <div class="block block-strong-ios block-outline-ios">
        <div class="block text-align-center">
          <img src="img/logo.png" />
        </div>
        <div class="block text-align-center">
          <h3>Vérifier votre numéro de téléphone</h3>
          <h4>
            Vérifiez vos messages, un SMS a été envoyé au numéro
            <span class="phone"></span>.
          </h4>
        </div>
        <form>
          <div class="list">
            <ul class="grid grid-cols-4 grid-gap">
              <li class="item-content item-input item-input-outline">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input
                      type="text"
                      placeholder=""
                      id="input1"
                      maxlength="1"
                    />
                  </div>
                </div>
              </li>
              <li class="item-content item-input item-input-outline">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input
                      type="text"
                      placeholder=""
                      id="input2"
                      maxlength="1"
                    />
                  </div>
                </div>
              </li>
              <li class="item-content item-input item-input-outline">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input
                      type="text"
                      placeholder=""
                      id="input3"
                      maxlength="1"
                    />
                  </div>
                </div>
              </li>
              <li class="item-content item-input item-input-outline">
                <div class="item-inner">
                  <div class="item-input-wrap">
                    <input
                      type="text"
                      placeholder=""
                      id="input4"
                      maxlength="1"
                    />
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <div class="list inset">
            <ul>
              <li>
                <a
                  class="button button-fill color-black list-button"
                  @click="${verifyPhone}"
                  >Valider</a
                >
              </li>
            </ul>
            <div class="block-footer text-align-center">
              Vous n'avez pas recu de SMS ?
              <a href="#" @click="${resendCode}"> Renvoyer le code</a>.
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>
<style>
  .md .item-input:not(.item-input-outline).item-content:before {
    background: transparent;
  }
  .page-verify-phone .list input[type="text"] {
    text-align: center !important;
    font-size: 35px !important;
  }
  .page-verify-phone .page-content {
    padding-top: calc(
      var(--f7-page-navbar-offset, 0px) +
        var(--f7-page-toolbar-top-offset, 120px) +
        var(--f7-page-subnavbar-offset, 0px) +
        var(--f7-page-searchbar-offset, 0px) +
        var(--f7-page-content-extra-padding-top, 0px)
    );
  }
</style>
<script>
  export default (props, { $, $f7, $on, $f7router }) => {
    $on("pageInit", () => {
      let phone = localStorage.getItem("phone");
      $(".phone").html(" " + phone);
    });

    const verifyPhone = () => {
      $f7.dialog.preloader("Un instant svp...");
      let input1 = $("#input1").val();
      let input2 = $("#input2").val();
      let input3 = $("#input3").val();
      let input4 = $("#input4").val();

      if (input1 == "" || input2 == "" || input3 == "" || input4 == "") {
        toastTop = $f7.toast.create({
          text: "Veuillez renseigner tous les champs SVP !",
          position: "top",
          cssClass: "toast_warning",
          closeTimeout: 3000,
        });

        // Open it
        toastTop.open();
      } else {
        let userId = localStorage.getItem("userId");
        let code = input1 + input2 + input3 + input4;
        // Envoyer la requête POST à l'API
        fetch(apiUrl + "/api/smscode/check", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
            "Access-Control-Allow-Origin": "*",
          },
          body: JSON.stringify({ userId: userId, code: code }),
        })
          .then(function (response) {
            if (response.status === 401) {
              return response.json().then((data) => {
                throw new Error(data.message); // Lance une erreur avec le message de la réponse
              });
            } else {
              if (!response.ok) {
                $f7.dialog.close();

                throw new Error("Erreur HTTP, statut " + response.status);
              }
            }
            return response.json();
          })
          .then(function (data) {
            toastTop = $f7.toast.create({
              text: "Code vérifié avec succès !",
              position: "top",
              cssClass: "toast_green",
              closeTimeout: 3000,
            });

            // Open it
            toastTop.open();

            app.views.main.router.navigate("/home/");
          })
          .catch(function (error) {
            $f7.dialog.close();
            // Gérer les erreurs (par exemple, afficher un message d'erreur)
            console.error("Erreur lors de la requête:", error);
            toastTop = $f7.toast.create({
              text: error,
              position: "top",
              cssClass: "toast_red",
              closeTimeout: 3000,
            });

            // Open it
            toastTop.open();
          });
      }
    };

    const resendCode = () => {
      $f7.dialog.preloader("Un instant svp...");

      let phone = localStorage.getItem("phone");

      // Envoyer la requête POST à l'API
      fetch(apiUrl + "/api/smscode/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
          "Access-Control-Allow-Origin": "*",
        },
        body: JSON.stringify({ phone: phone }),
      })
        .then(function (response) {
          $f7.dialog.close();
          if (response.status === 401) {
            return response.json().then((data) => {
              throw new Error(data.message); // Lance une erreur avec le message de la réponse
            });
          } else {
            if (!response.ok) {
              throw new Error("Erreur HTTP, statut " + response.status);
            }
          }
          return response.json();
        })
        .then(function (data) {
          $f7.dialog.close();
          toastTop = $f7.toast.create({
            text: "Un nouveau code a été envoyé avec succès !",
            position: "top",
            cssClass: "toast_info",
            closeTimeout: 3000,
          });

          // Open it
          toastTop.open();
        })
        .catch(function (error) {
          $f7.dialog.close();
          // Gérer les erreurs (par exemple, afficher un message d'erreur)
          console.error("Erreur lors de la requête:", error);
          toastTop = $f7.toast.create({
            text: error,
            position: "top",
            cssClass: "toast_red",
            closeTimeout: 3000,
          });

          // Open it
          toastTop.open();
        });
    };

    return $render;
  };
</script>
